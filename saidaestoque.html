<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Longitec - Sa√≠da de Estoque</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <aside class="sidebar">
    <h2>Longitec</h2>
    <nav>
      <a href="dashboard.html">üè† Dashboard</a>
      <a href="produtos.html">üì¶ Produtos</a>
      <a href="configuracoes.html">‚öôÔ∏è Configura√ß√µes</a>
      <a href="saidaestoque.html" class="active">üì¶ Sa√≠da de Estoque</a>
    </nav>
  </aside>

  <main class="main-content">
    <header><h1>Registrar Sa√≠da de Estoque</h1></header>

    <section class="add-form">
      <label for="produtoSelect" style="display:block; width:100%;">Produto:</label>
      <select id="produtoSelect"></select>

      <label for="tipoSaida" style="display:block; width:100%;">Motivo:</label>
      <select id="tipoSaida">
        <option value="venda">Venda</option>
        <option value="outro">Outro</option>
      </select>

      <input id="motivoOutro" type="text" placeholder="Descreva o motivo (se outro)" style="display:none; min-width:220px;" />

      <input id="responsavelInput" type="text" placeholder="Respons√°vel pela sa√≠da (nome)" style="min-width:220px;" />

      <!-- novo: input de data/hora da sa√≠da -->
      <label for="dataSaidaInput" style="display:block; width:100%;">Data e hora da sa√≠da:</label>
      <input id="dataSaidaInput" type="datetime-local" style="min-width:220px;" />

      <!-- novo: quantidade de sa√≠da -->
      <label for="qtdSaidaInput" style="display:block; width:100%;">Quantidade a retirar:</label>
      <input id="qtdSaidaInput" type="number" min="1" value="1" style="width:100px;" />

      <button id="regSaidaBtn" class="btn">Registrar sa√≠da</button>
      <small id="saidaMsg" style="display:block; margin-top:8px;"></small>
    </section>

    <section style="margin-top:18px;">
      <h3 style="color:var(--accent-2); margin-bottom:10px;">Produtos (visualiza√ß√£o r√°pida)</h3>
      <table class="product-table">
        <thead>
          <tr><th>ID</th><th>Nome</th><th>Estoque</th></tr>
        </thead>
        <tbody id="previewBody"></tbody>
      </table>
    </section>

    <section style="margin-top:18px;">
      <h3 style="color:var(--accent-2); margin-bottom:10px;">Registros de sa√≠da (√∫ltimos)</h3>
      <table class="product-table">
        <thead>
          <tr><th>Data</th><th>Produto</th><th>Qtd</th><th>Motivo</th><th>Respons√°vel</th></tr>
        </thead>
        <tbody id="registrosBody"></tbody>
      </table>
    </section>
  </main>

  <script>
    const produtoSelect = document.getElementById('produtoSelect');
    const regSaidaBtn = document.getElementById('regSaidaBtn');
    const saidaMsg = document.getElementById('saidaMsg');
    const previewBody = document.getElementById('previewBody');
    const tipoSaida = document.getElementById('tipoSaida');
    const motivoOutro = document.getElementById('motivoOutro');
    const responsavelInput = document.getElementById('responsavelInput');
    const registrosBody = document.getElementById('registrosBody');
    const dataSaidaInput = document.getElementById('dataSaidaInput');
    const qtdSaidaInput = document.getElementById('qtdSaidaInput');

    function escapeHtml(text) {
      return String(text || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // converte Date para valor compat√≠vel com <input type="datetime-local">
    function toDatetimeLocalValue(date) {
      const pad = (n) => String(n).padStart(2, '0');
      const yyyy = date.getFullYear();
      const mm = pad(date.getMonth() + 1);
      const dd = pad(date.getDate());
      const hh = pad(date.getHours());
      const min = pad(date.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
    }

    // se input tiver valor (local), converte para ISO (UTC)
    function datetimeLocalToISO(value) {
      if (!value) return new Date().toISOString();
      // new Date(value) interpreta value como local time
      return new Date(value).toISOString();
    }

    function carregarProdutos() {
      const produtos = JSON.parse(localStorage.getItem('produtos')) || [];
      produtoSelect.innerHTML = '';
      if (produtos.length === 0) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '-- nenhum produto cadastrado --';
        produtoSelect.appendChild(opt);
        produtoSelect.disabled = true;
        regSaidaBtn.disabled = true;
        qtdSaidaInput.disabled = true;
      } else {
        produtos.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = `${p.nome} ‚Äî (${p.qtd} un.)`;
          produtoSelect.appendChild(opt);
        });
        produtoSelect.disabled = false;
        regSaidaBtn.disabled = false;
        qtdSaidaInput.disabled = false;
      }

      // preview tabela
      previewBody.innerHTML = '';
      if (produtos.length === 0) {
        previewBody.innerHTML = '<tr><td colspan="3" class="text-center small text-muted">Nenhum produto</td></tr>';
      } else {
        produtos.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${p.id}</td><td>${escapeHtml(p.nome)}</td><td>${p.qtd}</td>`;
          previewBody.appendChild(tr);
        });
      }

      // ajusta max da quantidade para o produto selecionado (se houver)
      if (!produtoSelect.disabled) {
        produtoSelect.dispatchEvent(new Event('change'));
      }
    }

    function carregarRegistros() {
      const registros = JSON.parse(localStorage.getItem('saidas')) || [];
      registrosBody.innerHTML = '';
      if (registros.length === 0) {
        registrosBody.innerHTML = '<tr><td colspan="5" class="text-center small text-muted">Nenhum registro</td></tr>';
        return;
      }
      // mostrar os √∫ltimos 20 registros (mais recentes primeiro)
      const √∫ltimos = registros.slice(-20).reverse();
      √∫ltimos.forEach(r => {
        const dt = new Date(r.data).toLocaleString();
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${dt}</td><td>${escapeHtml(r.nome)}</td><td>${r.quantidade}</td><td>${escapeHtml(r.motivo)}</td><td>${escapeHtml(r.responsavel)}</td>`;
        registrosBody.appendChild(tr);
      });
    }

    // mostra/oculta input de motivo quando "Outro" selecionado
    tipoSaida.addEventListener('change', () => {
      motivoOutro.style.display = tipoSaida.value === 'outro' ? 'inline-block' : 'none';
    });

    // quando troca produto, ajusta m√°ximo da quantidade dispon√≠vel
    produtoSelect.addEventListener('change', () => {
      const selId = produtoSelect.value;
      const produtos = JSON.parse(localStorage.getItem('produtos')) || [];
      const p = produtos.find(x => String(x.id) === String(selId));
      if (!p) {
        qtdSaidaInput.max = '';
        return;
      }
      qtdSaidaInput.max = String(p.qtd);
      // se quantidade atual for maior que estoque, ajusta para estoque
      const cur = parseInt(qtdSaidaInput.value, 10) || 1;
      if (cur > Number(p.qtd)) qtdSaidaInput.value = p.qtd > 0 ? p.qtd : 1;
      atualizarTextoBotao();
    });

    // atualiza texto do bot√£o para mostrar quantidade selecionada
    function atualizarTextoBotao() {
      const q = parseInt(qtdSaidaInput.value, 10) || 1;
      regSaidaBtn.textContent = q > 1 ? `Registrar sa√≠da (-${q})` : 'Registrar sa√≠da (-1)';
    }

    qtdSaidaInput.addEventListener('input', () => {
      // for√ßa valor m√≠nimo 1
      if (qtdSaidaInput.value === '' || Number(qtdSaidaInput.value) < 1) qtdSaidaInput.value = 1;
      // respeita max (se definido)
      const max = parseInt(qtdSaidaInput.max, 10);
      if (max && Number(qtdSaidaInput.value) > max) qtdSaidaInput.value = max;
      atualizarTextoBotao();
    });

    regSaidaBtn.addEventListener('click', () => {
      const selId = produtoSelect.value;
      if (!selId) {
        saidaMsg.textContent = 'Selecione um produto.';
        return;
      }

      const responsavel = (responsavelInput.value || '').trim();
      if (!responsavel) {
        saidaMsg.textContent = 'Informe o respons√°vel pela sa√≠da.';
        return;
      }

      const produtos = JSON.parse(localStorage.getItem('produtos')) || [];
      const idx = produtos.findIndex(p => String(p.id) === String(selId));
      if (idx === -1) {
        saidaMsg.textContent = 'Produto n√£o encontrado.';
        return;
      }

      const disponivel = Number(produtos[idx].qtd);
      const qtd = Math.max(1, parseInt(qtdSaidaInput.value, 10) || 1);
      if (qtd <= 0) {
        saidaMsg.textContent = 'Quantidade inv√°lida.';
        return;
      }
      if (qtd > disponivel) {
        saidaMsg.textContent = `Estoque insuficiente. Dispon√≠vel: ${disponivel}.`;
        return;
      }

      // motivo
      const tipo = tipoSaida.value;
      const motivo = tipo === 'venda' ? 'Venda' : (motivoOutro.value.trim() || 'Outro');

      // data escolhida pelo usu√°rio (datetime-local) -> ISO
      const dataISO = datetimeLocalToISO(dataSaidaInput.value);

      // decrementa
      produtos[idx].qtd = Number(produtos[idx].qtd) - qtd;
      localStorage.setItem('produtos', JSON.stringify(produtos));

      // registra sa√≠da em hist√≥rico
      const registros = JSON.parse(localStorage.getItem('saidas')) || [];
      registros.push({
        produtoId: produtos[idx].id,
        nome: produtos[idx].nome,
        quantidade: qtd,
        motivo,
        tipo,
        responsavel,
        data: dataISO
      });
      localStorage.setItem('saidas', JSON.stringify(registros));

      saidaMsg.textContent = `Sa√≠da registrada: ${produtos[idx].nome} ‚Äî agora ${produtos[idx].qtd} unidade(s).`;
      // limpa campos leves
      responsavelInput.value = '';
      motivoOutro.value = '';
      tipoSaida.value = 'venda';
      motivoOutro.style.display = 'none';
      // reset data para hora atual
      dataSaidaInput.value = toDatetimeLocalValue(new Date());
      // reset quantidade para 1 (ou para m√°ximo dispon√≠vel se for menor)
      qtdSaidaInput.value = produtos[idx].qtd > 0 ? 1 : 1;
      atualizarTextoBotao();

      carregarProdutos();
      carregarRegistros();

      // limpa mensagem
      setTimeout(() => saidaMsg.textContent = '', 3500);
    });

    // Atualiza se outro separador modificar produtos ou registros
    window.addEventListener('storage', (e) => {
      if (e.key === 'produtos') carregarProdutos();
      if (e.key === 'saidas') carregarRegistros();
    });

    // inicializa: data atual no input e carrega dados
    dataSaidaInput.value = toDatetimeLocalValue(new Date());
    atualizarTextoBotao();
    carregarProdutos();
    carregarRegistros();
  </script>
</body>
</html>