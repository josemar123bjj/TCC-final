<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Longitec - Produtos</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <aside class="sidebar">
    <h2>Longitec</h2>
    <nav>
      <a href="dashboard.html">üè† Dashboard</a>
      <a href="produtos.html">üì¶ Produtos</a>
      <a href="configuracoes.html">‚öôÔ∏è Configura√ß√µes</a>
      <a href="saidaestoque.html">üì¶ Sa√≠da de Estoque</a>
    </nav>
  </aside>

  <main class="main-content">
    <header>
      <h1>Gerenciar Produtos</h1>
    </header>

    <section class="add-form">
      <input id="nomeInput" type="text" placeholder="Nome do produto">
      <input id="qtdInput" type="number" placeholder="Qtd. em estoque">
      <input id="precoInput" type="number" placeholder="Pre√ßo (R$)" step="0.01">
      <button id="addBtn">Adicionar</button>
      <button id="cancelEditBtn" style="display:none;margin-left:8px;">Cancelar</button>
    </section>

    <table class="product-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nome</th>
          <th>Estoque</th>
          <th>Pre√ßo (R$)</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <!-- Linhas ser√£o adicionadas dinamicamente -->
      </tbody>
    </table>

    <!-- gr√°fico de estoque -->
    <section class="chart-section" style="margin-top:18px;">
      <h3 style="color:var(--accent-2); margin-bottom:10px;">Produtos em estoque</h3>
      <div style="width:100%; max-width:900px;">
        <canvas id="estoqueChart" height="140"></canvas>
      </div>
      <small id="chartEmptyMsg" style="display:none;">Nenhum produto para exibir no gr√°fico.</small>
    </section>
  </main>

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const addBtn = document.getElementById('addBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const nomeInput = document.getElementById('nomeInput');
    const qtdInput = document.getElementById('qtdInput');
    const precoInput = document.getElementById('precoInput');
    const tableBody = document.querySelector('.product-table tbody');

    // novo: elementos do gr√°fico
    const chartCanvas = document.getElementById('estoqueChart');
    const chartEmptyMsg = document.getElementById('chartEmptyMsg');
    let estoqueChart = null;

    // Carrega produtos salvos do localStorage
    let produtos = JSON.parse(localStorage.getItem('produtos')) || [];
    let id = produtos.length ? Math.max(...produtos.map(p => p.id)) + 1 : 1;
    let editingId = null;

    // Fun√ß√£o para renderizar tabela
    function renderTabela() {
      tableBody.innerHTML = "";
      if(produtos.length === 0){
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center small text-muted">Nenhum produto</td></tr>';
      } else {
        produtos.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${p.id}</td>
            <td>${escapeHtml(p.nome)}</td>
            <td>${p.qtd}</td>
            <td>${parseFloat(p.preco).toFixed(2)}</td>
            <td>
              <button class="edit-btn" data-id="${p.id}">‚úèÔ∏è Editar</button>
              <button class="delete-btn" data-id="${p.id}">üóëÔ∏è Excluir</button>
            </td>
          `;
          tableBody.appendChild(tr);
        });

        // Adiciona eventos de exclus√£o
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const idRemover = parseInt(e.target.dataset.id, 10);
            if(!confirm('Excluir produto selecionado?')) return;
            produtos = produtos.filter(prod => prod.id !== idRemover);
            localStorage.setItem('produtos', JSON.stringify(produtos));
            // if we're editing the deleted item, cancel edit
            if(editingId === idRemover) cancelEdit();
            renderTabela();
            renderChart(); // atualizar gr√°fico
          });
        });

        // Adiciona eventos de edi√ß√£o
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const idEditar = parseInt(e.target.dataset.id, 10);
            startEdit(idEditar);
          });
        });
      }

      renderChart();
    }

    function startEdit(idEditar){
      const produto = produtos.find(p => p.id === idEditar);
      if(!produto) return;
      editingId = idEditar;
      nomeInput.value = produto.nome;
      qtdInput.value = produto.qtd;
      precoInput.value = produto.preco;
      addBtn.textContent = 'Salvar altera√ß√µes';
      cancelEditBtn.style.display = 'inline-block';
      nomeInput.focus();
    }

    function cancelEdit(){
      editingId = null;
      nomeInput.value = '';
      qtdInput.value = '';
      precoInput.value = '';
      addBtn.textContent = 'Adicionar';
      cancelEditBtn.style.display = 'none';
    }

    // Renderiza ao carregar a p√°gina
    renderTabela();

    // Adiciona novo produto ou salva edi√ß√£o
    addBtn.addEventListener('click', () => {
      const nome = nomeInput.value.trim();
      const qtd = qtdInput.value.trim();
      const preco = precoInput.value.trim();

      if (!nome || qtd === '' || preco === '') {
        alert("Preencha todos os campos!");
        return;
      }

      if(editingId !== null){
        // salvar altera√ß√µes
        const idx = produtos.findIndex(p => p.id === editingId);
        if(idx >= 0){
          produtos[idx].nome = nome;
          produtos[idx].qtd = parseInt(qtd, 10);
          produtos[idx].preco = parseFloat(preco);
          localStorage.setItem('produtos', JSON.stringify(produtos));
          cancelEdit();
          renderTabela();
        }
        return;
      }

      const novoProduto = {
        id: id++,
        nome,
        qtd: parseInt(qtd, 10),
        preco: parseFloat(preco)
      };

      produtos.push(novoProduto);
      localStorage.setItem('produtos', JSON.stringify(produtos));
      renderTabela();
      nomeInput.value = "";
      qtdInput.value = "";
      precoInput.value = "";
      // gr√°fico ser√° atualizado em renderTabela()
    });

    cancelEditBtn.addEventListener('click', () => {
      cancelEdit();
    });

    // Fun√ß√£o do gr√°fico
    function renderChart(){
      // se n√£o existe canvas (por algum motivo), aborta
      if(!chartCanvas) return;

      if(estoqueChart){
        estoqueChart.destroy();
        estoqueChart = null;
      }

      if(!produtos || produtos.length === 0){
        chartCanvas.style.display = 'none';
        chartEmptyMsg.style.display = 'inline-block';
        return;
      }

      chartCanvas.style.display = 'block';
      chartEmptyMsg.style.display = 'none';

      const labels = produtos.map(p => escapeHtml(p.nome));
      const data = produtos.map(p => Number(p.qtd));

      // cores simples
      const backgroundColors = labels.map((_, i) => {
        const base = 200 - (i * 6 % 120);
        return `rgba(${37 + i*10 % 200}, ${99 + i*6 % 156}, ${235 - i*4 % 100}, 0.85)`;
      });

      const ctx = chartCanvas.getContext('2d');
      estoqueChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Quantidade em estoque',
            data,
            backgroundColor: backgroundColors,
            borderColor: backgroundColors.map(c => c.replace('0.85','1')),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: { color: '#0b1220' },
              title: { display: false }
            },
            y: {
              beginAtZero: true,
              ticks: { precision:0, color: '#0b1220' },
              title: { display: true, text: 'Unidades' }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: { mode: 'index', intersect: false }
          },
          interaction: {
            mode: 'nearest',
            intersect: false
          }
        }
      });
    }

    function escapeHtml(text) {
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    // garante que o gr√°fico seja renderizado corretamente ap√≥s carregar
    window.addEventListener('load', renderChart);
  </script>
</body>
</html>